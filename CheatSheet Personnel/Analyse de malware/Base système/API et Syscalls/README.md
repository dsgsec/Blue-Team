# Cheatsheet des API et Syscalls dans Windows

## Introduction

Les applications en mode utilisateur ne peuvent pas interagir directement avec le matériel. La plupart des API appelées par les applications en mode utilisateur finissent par invoquer des routines de service système (fonctions) implémentées dans le noyau de Windows (ntoskrnl.exe), qui interagit ensuite avec le matériel (par exemple, pour écrire dans un fichier sur le disque). De même, toute application en mode utilisateur qui appelle une API liée à l'interface graphique se termine en appelant les fonctions exposées par win32k.sys dans l'espace du noyau.

## Processus d'Appel d'API

### 1. Appel de l'API au niveau de l'application
- **Description**: Lorsqu'une application a besoin d'effectuer une tâche comme écrire dans un fichier, elle commence par appeler une API appropriée.
- **Exemple**: L'application appelle `WriteFile` de la bibliothèque Windows API (kernel32.dll ou kernelbase.dll sous les versions modernes de Windows).
- **Utilité**: C'est la fonction que les développeurs utilisent pour effectuer des écritures de fichiers.

### 2. Redirection vers ntdll.dll
- **Description**: `WriteFile` agit comme une enveloppe qui prépare les arguments et les données nécessaires, puis délègue l'opération à une fonction dans ntdll.dll.
- **Exemple**: Pour `WriteFile`, l'API correspondante dans ntdll.dll est `NtWriteFile`.
- **Utilité**: ntdll.dll contient les appels système (syscalls), qui sont des points d'entrée vers les services du noyau.

### 3. Appel au noyau via ntoskrnl.exe
- **Description**: `NtWriteFile` transmet l'appel au noyau Windows (ntoskrnl.exe).
- **Exemple**: ntoskrnl.exe contient le code du noyau qui gère des fonctions essentielles comme la gestion des fichiers. Les adresses de ces fonctions sont mappées dans la table SSDT (System Service Dispatch Table) chargée par ntoskrnl.exe.
- **Utilité**: Convertit les demandes de niveau utilisateur en actions de niveau noyau.

### 4. Traitement et retour
- **Description**: Après que l'opération est effectuée par le noyau, les résultats et le statut de l'opération sont renvoyés à travers la pile d'appels.
- **Exemple**: De ntoskrnl.exe à `NtWriteFile` dans ntdll.dll, puis à `WriteFile` dans kernel32.dll/kernelbase.dll, et enfin à l'application appelante avec un indicateur de succès ou d'échec.
- **Utilité**: Retourne le contrôle à l'application avec les résultats de l'opération.

## HAL (Hardware Abstraction Layer)
- **Description**: `hal.dll` est une bibliothèque de liens dynamiques (DLL) essentielle qui fournit une interface standard entre le système d'exploitation et le matériel de l'ordinateur.
- **Utilité**: Abstrait les détails matériels spécifiques, permettant au système d'exploitation de fonctionner sur une large gamme de matériels sans modification spécifique.

## Exemples Vulgarisés

### Exemple de Processus d'Appel d'API
- **Situation**: Une application de traitement de texte veut enregistrer un document sur le disque dur.
- **Action**: L'application appelle `WriteFile` pour écrire les données.
- **Processus**:
  1. **Application**: Appelle `WriteFile` de kernel32.dll.
  2. **Redirection**: `WriteFile` passe l'appel à `NtWriteFile` dans ntdll.dll.
  3. **Noyau**: `NtWriteFile` transmet l'appel au noyau via ntoskrnl.exe.
  4. **Traitement**: Le noyau écrit les données sur le disque et retourne le résultat.
- **Résultat**: Le document est enregistré, et l'application reçoit un indicateur de succès.

### Exemple de HAL
- **Situation**: Différents modèles d'ordinateurs ont des cartes mères, processeurs et périphériques variés.
- **Action**: `hal.dll` fournit une couche d'abstraction pour interagir avec ces différents composants matériels.
- **Utilité**: Permet au même système d'exploitation de fonctionner sur différents matériels sans modification spécifique.
- **Exemple**: Le système d'exploitation peut accéder à la mémoire, aux processeurs et aux périphériques de manière standardisée, peu importe le matériel sous-jacent.

## Diagramme de Flux


```plaintext
+-------------------+                       +-------------------+                        +-------------------+                        +--------------------+
|                   |                       |                   |                        |                   |                        |                    |
| Application       |                       | ntdll.dll         |                        | ntoskrnl.exe      |                        | Matériel           |
|                   |                       |                   |                        |                   |                        |                    |
| +---------------+ |                       | +---------------+ |                        | +---------------+ |                        |                    |
| | WriteFile     | +----------------------> | | NtWriteFile  | +----------------------> | | File System   | +----------------------> |                    |
| +---------------+ |                       | +---------------+ |                        | +---------------+ |                        |                    |
|                   |                       |                   |                        |                   |                        |                    |
+-------------------+                       +-------------------+                        +-------------------+                        +--------------------+

1. L'application appelle l'API WriteFile.
2. WriteFile appelle NtWriteFile dans ntdll.dll.
3. NtWriteFile transmet l'appel au noyau via ntoskrnl.exe.
4. Le noyau effectue l'opération sur le matériel.
5. Les résultats sont renvoyés à travers la pile d'appels dans l'ordre inverse.
