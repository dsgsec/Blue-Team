# Cheatsheet des Processus dans Windows

## Introduction

Chaque processus est isolé et ne peut communiquer avec d'autres processus qu'à travers les mécanismes fournis par le système d'exploitation (IPC: mémoire partagée, sockets, pipes, etc.). Chaque processus a l'impression d'être le seul à être exécuté. Dans un processus 32 bits, l'adresse s'étend de 0x00000000 à 0xFFFFFFFF, où 0x00000000 à 0x7FFFFFFF est affecté à l'espace utilisateur (user-land) et 0x80000000 à 0xFFFFFFFF est affecté à l'espace noyau (kernel-land).

## Composants de la Mémoire d'un Processus

### Stack (La Pile)
- **Description**: Zone de mémoire permettant de stocker les valeurs des paramètres d'entrée passés aux fonctions, les valeurs de résultats, les adresses de retour, et les variables locales des fonctions.
- **Utilité**: Gère l'appel et le retour des fonctions de manière organisée.

### Heap (Le Tas)
- **Description**: Portion de mémoire allouée dynamiquement pour stocker des variables globales. L'allocation de mémoire doit être gérée par l'application.
- **Utilité**: Utilisé pour des allocations de mémoire à long terme, contrairement à la pile.

### Program Image (Image du Programme)
- **Description**: Contient l'exécutable, y compris la section `.text` (code exécutable), la section `.data` (données globales), et la section `.rsrc` (ressources non exécutables).
- **Utilité**: Stocke le code et les données nécessaires à l'exécution du programme.

### DLL (Bibliothèques de Liens Dynamiques)
- **Description**: Bibliothèques de code partagées permettant la réutilisation du code et une allocation efficace de la mémoire.
- **Utilité**: Contiennent le code et les appels système pour interagir avec le noyau et le matériel.

### PEB (Process Environment Block)
- **Description**: Contient les informations telles que l'adresse de base de l'image, l'emplacement du tas, les modules chargés (DLL), et les variables d'environnement.
- **Utilité**: Centralise les informations sur l'environnement du processus.

### TEB (Thread Environment Block)
- **Description**: Décrit l'état d'un thread et inclut l'emplacement du PEB en mémoire, l'emplacement de la pile du thread, et un pointeur vers la première entrée de la chaîne SEH (Structured Exception Handling).
- **Utilité**: Stocke les informations de contexte pour le chargeur d'images et diverses DLL Windows.

## Processus de Création et d'Exécution d'un Processus

### 1. Chargement de l'Exécutable
- **Description**: L'exécutable du processus et toutes ses DLL associées sont chargées en mémoire par le chargeur Windows.
- **Utilité**: Prépare le processus pour l'exécution.

### 2. Création du Thread Principal
- **Description**: Le thread principal est créé et commence à lire le code exécutable de la mémoire.
- **Utilité**: Le thread exécute le code, tandis que le processus sert de conteneur pour les threads.

### 3. Exécution en Mode Utilisateur
- **Description**: Le thread commence à s'exécuter en mode utilisateur avec accès restreint.
- **Utilité**: Assure que le code du processus s'exécute avec des permissions limitées pour la sécurité.

## Diagramme de Flux

```plaintext
+-------------------+                       +-------------------+                        +-------------------+                        +--------------------+
|                   |                       |                   |                        |                   |                        |                    |
| Application       |                       | ntdll.dll         |                        | ntoskrnl.exe      |                        | Matériel           |
|                   |                       |                   |                        |                   |                        |                    |
| +---------------+ |                       | +---------------+ |                        | +---------------+ |                        |                    |
| | WriteFile     | +----------------------> | | NtWriteFile  | +----------------------> | | File System   | +----------------------> |                    |
| +---------------+ |                       | +---------------+ |                        | +---------------+ |                        |                    |
|                   |                       |                   |                        |                   |                        |                    |
+-------------------+                       +-------------------+                        +-------------------+                        +--------------------+

+--------------------+                       +--------------------+                        +--------------------+                        +--------------------+
|                    |                       |                    |                        |                    |                        |                    |
| Processus         |                       | Espace Utilisateur |                        | Espace Noyau       |                        | Matériel           |
|                    |                       |                    |                        |                    |                        |                    |
| +----------------+ |                       | +----------------+ |                        | +----------------+ |                        |                    |
| | Executable     | +----------------------> | | Stack         | +----------------------> | | ntoskrnl.exe    | +----------------------> |                    |
| | (Program Image)| |                       | |                | |                        | | (Kernel)        | |                        |                    |
| +----------------+ |                       | +----------------+ |                        | +----------------+ |                        |                    |
|                    |                       | +----------------+ |                        | +----------------+ |                        |                    |
| +----------------+ |                       | | Heap           | +----------------------> | | HAL (hal.dll)   | +----------------------> |                    |
| | DLL            | |                       | |                | |                        | | (Hardware Abstraction) |                    |
| +----------------+ |                       | +----------------+ |                        | +----------------+ |                        |                    |
|                    |                       |                    |                        |                    |                        |                    |
+--------------------+                       +--------------------+                        +--------------------+                        +--------------------+

1. L'exécutable du processus et ses DLL sont chargés en mémoire.
2. Le thread principal est créé et commence à lire le code exécutable.
3. Le thread s'exécute en mode utilisateur.
4. Les appels système passent par ntdll.dll et ntoskrnl.exe pour interagir avec le matériel via HAL.
