Analyse dynamique
=================

Dans le domaine de l'analyse des malwares, l'analyse dynamique ou comportementale représente une approche indispensable dans notre arsenal d'investigation. Dans l'analyse dynamique, nous observons et interprétons le comportement du malware pendant son exécution ou en action. Il s'agit d'un contraste crucial avec l'analyse statique, où nous disséquons les propriétés et le contenu du malware sans l'exécuter. L'objectif principal de l'analyse dynamique est de documenter et de comprendre l'impact réel du malware sur son environnement hôte, ce qui en fait une partie intégrante d'une analyse complète des malwares.

Lors de l'exécution d'une analyse dynamique, nous encapsulons le logiciel malveillant dans un environnement étroitement contrôlé, surveillé et généralement isolé pour empêcher toute propagation ou tout dommage involontaire. Cet environnement est généralement une machine virtuelle (VM) dont le malware ignore l'existence. Il croit qu'il interagit avec un véritable système, alors que nous, en tant que chercheurs, avons un contrôle total sur ses interactions et pouvons documenter minutieusement son comportement.

Notre procédure d'analyse dynamique peut être décomposée en les étapes suivantes :

-   `Environment Setup`: Nous établissons d'abord un environnement sécurisé et contrôlé, généralement un `VM`environnement isolé du reste du réseau pour éviter toute contamination ou propagation accidentelle du malware. La configuration de la VM doit imiter un système réel, complet avec les logiciels, les applications et les configurations réseau qu'un utilisateur réel pourrait avoir.

-   `Baseline Capture`: Une fois l'environnement configuré, nous capturons un instantané de l'état propre du système. Cela inclut `system files`, `registry states`, `running processes`, `network configuration`et plus encore. Cette ligne de base sert de point de référence pour identifier les modifications apportées par le logiciel malveillant après son exécution.

-   `Tool Deployment (Pre-Execution)`: Pour capturer efficacement les activités des logiciels malveillants, nous déployons divers outils de surveillance et de journalisation. Des outils tels que `Process Monitor (Procmon)`Sysinternals Suite sont utilisés pour enregistrer les appels système, l'activité du système de fichiers, les opérations de registre, etc. Nous pouvons également utiliser des utilitaires tels que , `Wireshark`et `tcpdump`pour `Fiddler`capturer le trafic réseau et `Regshot`prendre des instantanés avant et après du registre système. Enfin, des outils tels que `INetSim`, `FakeDNS`, et `FakeNet-NG`sont utilisés pour simuler les services Internet.

-   `Malware Execution`: Une fois nos outils opérationnels et prêts, nous procédons à l'exécution de l'échantillon de malware dans l'environnement isolé. Pendant l'exécution, les outils de surveillance capturent et enregistrent toutes les activités, y compris la création de processus, les modifications de fichiers et de registre, le trafic réseau, etc.

-   `Observation and Logging`: L'échantillon de malware est autorisé à s'exécuter pendant une durée suffisante. Pendant ce temps, nos outils de surveillance enregistrent avec diligence chacun de ses mouvements, ce qui nous fournira un aperçu complet de son comportement et de son mode de fonctionnement.

-   `Analysis of Collected Data`: Une fois le malware terminé, nous arrêtons son exécution et arrêtons les outils de surveillance. Nous examinons maintenant les journaux et les données collectées, en comparant l'état du système à notre référence initiale pour identifier les changements introduits par le malware.

Dans certains cas, lorsque le malware est particulièrement évasif ou complexe, nous pouvons utiliser des environnements sandbox pour une analyse dynamique. Les bacs à sable, tels que `Cuckoo Sandbox`, `Joe Sandbox`, ou `FireEye's Dynamic Threat Intelligence cloud`, fournissent un environnement automatisé, sécurisé et hautement contrôlé pour l'exécution de logiciels malveillants. Ils sont équipés de nombreuses fonctionnalités pour une analyse comportementale approfondie et génèrent des rapports détaillés sur le comportement réseau du malware, l'interaction du système de fichiers, l'empreinte mémoire, etc.

Cependant, il est important de garder à l'esprit que même si les environnements sandbox sont des outils précieux, ils ne sont pas infaillibles. Certains logiciels malveillants avancés peuvent détecter les environnements sandbox et modifier leur comportement en conséquence, ce qui rend plus difficile pour les chercheurs de déterminer leur véritable nature.

Naviguons maintenant vers le bas de cette section et cliquons sur "Cliquez ici pour générer le système cible !". Ensuite, passons à RDP dans l'adresse IP cible en utilisant les informations d'identification fournies. La grande majorité des actions/commandes couvertes de ce point à la fin de cette section peuvent être répliquées dans la cible, offrant ainsi une compréhension plus complète des sujets présentés.

```
dsgsec@htb[/htb]$ xfreerdp /u:htb-student /p:'HTB_@cademy_stdnt!' /v:[Target IP] /dynamic-resolution

```

Analyse dynamique avec Noriben
------------------------------

[Noriben](https://github.com/Rurik/Noriben) est un outil puissant de notre boîte à outils d'analyse dynamique, agissant essentiellement comme un wrapper Python pour Sysinternals `ProcMon`, un utilitaire complet de surveillance du système. Il orchestre le fonctionnement de `ProcMon`, affine le résultat et ajoute au processus une couche d'intelligence spécifique aux logiciels malveillants. En tirant parti de `Noriben`, nous pouvons capturer plus facilement les comportements des logiciels malveillants et les comprendre plus précisément.

Pour comprendre comment `Noriben`renforcent nos efforts d'analyse dynamique, commençons par examiner rapidement `ProcMon`. Cet outil, de `Sysinternals Suite`, surveille en temps réel le système de fichiers, le registre et l'activité des processus/threads. Il combine les fonctionnalités d'utilitaires tels que `Filemon`, `Regmon`et des fonctionnalités avancées telles que le filtrage, la mise en évidence avancée et des propriétés d'événement étendues, ce qui en fait un puissant outil de surveillance du système pour l'analyse des logiciels malveillants.

Cependant, le volume et l'étendue des informations `ProcMon`collectées peuvent être considérables. Sans un filtrage et une analyse contextuelle appropriés, passer au crible ces données brutes devient un défi considérable. C'est là que Noriben intervient. Il `ProcMon`capture les événements du système, puis filtre et analyse ces données pour extraire des informations significatives et identifier les activités malveillantes.

Dans notre processus d'analyse dynamique des logiciels malveillants, voici comment nous utilisons Noriben :

-   `Setting Up Noriben`: On lance `Noriben`en le lançant depuis la ligne de commande. L'outil prend en charge de nombreux arguments de ligne de commande pour personnaliser son fonctionnement. `ProcMon`Par exemple, nous pouvons définir la durée de la collecte des données, spécifier un échantillon de malware personnalisé à exécuter ou sélectionner un fichier de configuration personnalisé .

-   `Launching ProcMon`: Au lancement, `Noriben`démarre `ProcMon`avec une configuration prédéfinie. Cette configuration contient un ensemble de filtres conçus pour exclure l'activité normale du système et se concentrer sur les indicateurs potentiels d'actions malveillantes.

-   `Executing the Malware Sample`: Lors de `ProcMon`l'exécution, `Noriben`exécute l'échantillon de malware sélectionné. Au cours de cette phase, `ProcMon`capture toutes les activités du système, y compris les opérations de processus, les modifications du système de fichiers et les modifications du registre.

-   `Monitoring and Logging`: `Noriben`contrôle la durée de la surveillance, et une fois terminée, il commande `ProcMon`de sauvegarder les données collectées dans un fichier CSV, puis termine ProcMon.

-   `Data Analysis and Reporting`: C'est là que `Noriben`brille. Il traite le fichier CSV généré par `ProcMon`, en appliquant des filtres supplémentaires et en effectuant une analyse contextuelle. `Noriben`identifie les activités potentiellement suspectes et les organise en différentes catégories, telles que l'activité du système de fichiers, les opérations de processus et les connexions réseau. Ce processus aboutit à un rapport clair et lisible au format HTML ou TXT, mettant en évidence les caractéristiques comportementales du malware analysé.

L'intégration de Noriben avec les règles YARA est une autre caractéristique notable. Nous pouvons exploiter les règles YARA pour améliorer nos capacités de filtrage des données, nous permettant ainsi d'identifier plus efficacement les modèles d'intérêt.

* * * * *

À des fins de démonstration, nous effectuerons une analyse dynamique sur un spécimen de malware nommé `shell.exe`, trouvé dans le `C:\Samples\MalwareAnalysis`répertoire de la machine cible de cette section. Suivez ces étapes:

-   Lancez une nouvelle interface de ligne de commande et accédez au `C:\Tools\Noriben-master`répertoire.

-   Initiez Noriben comme indiqué.

```
C:\Tools\Noriben-master> python .\Noriben.py
[*] Using filter file: ProcmonConfiguration.PMC
[*] Using procmon EXE: C:\ProgramData\chocolatey\bin\procmon.exe
[*] Procmon session saved to: Noriben_27_Jul_23__23_40_319983.pml
[*] Launching Procmon ...
[*] Procmon is running. Run your executable now.
[*] When runtime is complete, press CTRL+C to stop logging.

```

-   Lorsque vous voyez l' `User Account Control`invite, sélectionnez `Yes`.

-   Procédez `C:\Samples\MalwareAnalysis`et activez `shell.exe`en double-cliquant.

-   `shell.exe`identifiera qu'il s'exécute dans un bac à sable. Fermez la fenêtre qu'il a créée.

-   Terminer `ProcMon`.

-   Dans l'invite de commande exécutant Noriben, utilisez la `Ctrl+C`commande pour cesser son fonctionnement.

```
C:\Tools\Noriben-master> python .\Noriben.py
[*] Using filter file: ProcmonConfiguration.PMC
[*] Using procmon EXE: C:\ProgramData\chocolatey\bin\procmon.exe
[*] Procmon session saved to: Noriben_27_Jul_23__23_40_319983.pml
[*] Launching Procmon ...
[*] Procmon is running. Run your executable now.
[*] When runtime is complete, press CTRL+C to stop logging.

[*] Termination of Procmon commencing... please wait
[*] Procmon terminated
[*] Saving report to: Noriben_27_Jul_23__23_42_335666.txt
[*] Saving timeline to: Noriben_27_Jul_23__23_42_335666_timeline.csv
[*] Exiting with error code: 0: Normal exit

```

Vous observerez que Noriben génère un `.txt`rapport dans son répertoire, compilant toutes les informations comportementales qu'il a réussi à collecter.

![Image](https://academy.hackthebox.com/storage/modules/227/noriben2.png)

Comme indiqué, `Noriben`utilise `ProcMon`pour capturer les événements du système, puis filtre et analyse ces données pour extraire des informations significatives et identifier les activités malveillantes.

`Noriben`pourrait filtrer certaines informations potentiellement précieuses. Par exemple, nous ne recevons aucune donnée pertinente du rapport de Noriben sur la façon dont `shell.exe`il a reconnu son fonctionnement dans un bac à sable ou une machine virtuelle.

Adoptons une approche différente et lançons manuellement `ProcMon`(disponible sur `C:\Tools\sysinternals`) en utilisant sa configuration par défaut, plus inclusive. Suite à cela, réexécutons `shell.exe`. Cela pourrait nous donner un aperçu de la façon dont `shell.exe`détecte la présence d'un bac à sable ou d'une machine virtuelle.

Ensuite, configurons le filtre ( `Ctrl+L`) comme suit et appuyons sur `Apply`.

![Image](https://academy.hackthebox.com/storage/modules/227/filter.png)

Enfin, naviguons jusqu'à la fin des résultats. Il peut être observé qu'il `shell.exe`effectue une détection de bac à sable ou de machine virtuelle en interrogeant le registre pour connaître la présence de `VMware Tools`.

![Image](https://academy.hackthebox.com/storage/modules/227/results1.png)