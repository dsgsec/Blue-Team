Création de règles de détection
===============================

Ayant maintenant découvert les tactiques, techniques et procédures (TTP) utilisées par ce malware, nous pouvons procéder à la conception de règles de détection, telles que les règles `Yara`et `Sigma`les règles.

Bien que nous commencions à approfondir les concepts de développement des règles Yara et Sigma dans cette section, nous ne ferons qu'effleurer la surface. Il s'agit de sujets vastes et très approfondis, qui nécessitent une étude approfondie. C'est pourquoi nous consacrerons un module complet nommé « YARA & Sigma pour les analystes SOC » pour vous aider à véritablement maîtriser ces domaines cruciaux de la cyberdéfense.

Naviguons maintenant vers le bas de cette section et cliquons sur "Cliquez ici pour générer le système cible !". Ensuite, connectons SSH à l'adresse IP cible en utilisant les informations d'identification fournies. La grande majorité des actions/commandes couvertes de ce point à la fin de cette section peuvent être répliquées dans la cible, offrant ainsi une compréhension plus complète des sujets présentés.

Yara
----

`YARA (Yet Another Recursive Acronym)`, un outil de correspondance de modèles open source largement utilisé et un cadre de détection et de classification des logiciels malveillants basé sur des règles nous permettent de créer des règles personnalisées pour repérer des modèles ou des caractéristiques spécifiques dans les fichiers, les processus ou la mémoire. Pour rédiger une `YARA`règle pour notre échantillon, nous devrons examiner le comportement, les fonctionnalités ou les chaînes/modèles spécifiques uniques à l'échantillon que nous souhaitons détecter.

Voici un exemple simple de `YARA`règle qui correspond à la présence de la chaîne `Sandbox detected`dans un processus. Nous vous rappelons que `shell.exe`démontré un tel comportement.

Code : Yara

```
rule Shell_Sandbox_Detection {
    strings:
        $sandbox_string = "Sandbox detected"
    condition:
        $sandbox_string
}

```

Ajoutons maintenant beaucoup plus de chaînes et de modèles à la règle pour l'améliorer.

Nous pouvons utiliser l' `yarGen`outil, qui automatise le processus de génération `YARA`de règles, dans le but principal d'élaborer les meilleures règles possibles pour le post-traitement manuel. Cela nécessite toutefois une présélection automatique astucieuse et un analyste humain perspicace pour générer une règle robuste.

Créons d'abord un nouveau répertoire appelé `Test`dans le `/home/htb-student/Samples/MalwareAnalysis`répertoire de la cible de cette section, puis copions `shell.exe`(résidant dans le `/home/htb-student/Samples/MalwareAnalysis`répertoire) dans le `Test`répertoire nouvellement créé comme suit.

```
dsgsec@htb[/htb]$ mkdir /home/htb-student/Samples/MalwareAnalysis/Test

```

```
dsgsec@htb[/htb]$ cp /home/htb-student/Samples/MalwareAnalysis/shell.exe /home/htb-student/Samples/MalwareAnalysis/Test/

```

Pour créer automatiquement une règle Yara, `shell.exe`nous devons exécuter ce qui suit (à l'intérieur du `/home/htb-student/yarGen-0.23.4`répertoire).

```
dsgsec@htb[/htb]$ sudo python3 yarGen.py -m /home/htb-student/Samples/MalwareAnalysis/Test/
------------------------------------------------------------------------
                   _____
    __ _____ _____/ ___/__ ___
   / // / _ `/ __/ (_ / -_) _\
   \_, /\_,_/_/  \___/\__/_//_/
  /___/  Yara Rule Generator
         Florian Roth, July 2020, Version 0.23.3

  Note: Rules have to be post-processed
  See this post for details: https://medium.com/@cyb3rops/121d29322282
------------------------------------------------------------------------
[+] Using identifier 'Test'
[+] Using reference 'https://github.com/Neo23x0/yarGen'
[+] Using prefix 'Test'
[+] Processing PEStudio strings ...
[+] Reading goodware strings from database 'good-strings.db' ...
    (This could take some time and uses several Gigabytes of RAM depending on your db size)
[+] Loading ./dbs/good-imphashes-part3.db ...
[+] Total: 4029 / Added 4029 entries
[+] Loading ./dbs/good-strings-part9.db ...
[+] Total: 788 / Added 788 entries
[+] Loading ./dbs/good-strings-part8.db ...
[+] Total: 332082 / Added 331294 entries
[+] Loading ./dbs/good-imphashes-part4.db ...
[+] Total: 6426 / Added 2397 entries
[+] Loading ./dbs/good-strings-part2.db ...
[+] Total: 1703601 / Added 1371519 entries
[+] Loading ./dbs/good-exports-part2.db ...
[+] Total: 90960 / Added 90960 entries
[+] Loading ./dbs/good-strings-part4.db ...
[+] Total: 3860655 / Added 2157054 entries
[+] Loading ./dbs/good-exports-part4.db ...
[+] Total: 172718 / Added 81758 entries
[+] Loading ./dbs/good-exports-part7.db ...
[+] Total: 223584 / Added 50866 entries
[+] Loading ./dbs/good-strings-part6.db ...
[+] Total: 4571266 / Added 710611 entries
[+] Loading ./dbs/good-strings-part7.db ...
[+] Total: 5828908 / Added 1257642 entries
[+] Loading ./dbs/good-exports-part1.db ...
[+] Total: 293752 / Added 70168 entries
[+] Loading ./dbs/good-exports-part3.db ...
[+] Total: 326867 / Added 33115 entries
[+] Loading ./dbs/good-imphashes-part9.db ...
[+] Total: 6426 / Added 0 entries
[+] Loading ./dbs/good-exports-part9.db ...
[+] Total: 326867 / Added 0 entries
[+] Loading ./dbs/good-imphashes-part5.db ...
[+] Total: 13764 / Added 7338 entries
[+] Loading ./dbs/good-imphashes-part8.db ...
[+] Total: 13947 / Added 183 entries
[+] Loading ./dbs/good-imphashes-part6.db ...
[+] Total: 13976 / Added 29 entries
[+] Loading ./dbs/good-strings-part1.db ...
[+] Total: 6893854 / Added 1064946 entries
[+] Loading ./dbs/good-imphashes-part7.db ...
[+] Total: 17382 / Added 3406 entries
[+] Loading ./dbs/good-exports-part6.db ...
[+] Total: 328525 / Added 1658 entries
[+] Loading ./dbs/good-imphashes-part2.db ...
[+] Total: 18208 / Added 826 entries
[+] Loading ./dbs/good-exports-part8.db ...
[+] Total: 332359 / Added 3834 entries
[+] Loading ./dbs/good-strings-part3.db ...
[+] Total: 9152616 / Added 2258762 entries
[+] Loading ./dbs/good-strings-part5.db ...
[+] Total: 12284943 / Added 3132327 entries
[+] Loading ./dbs/good-imphashes-part1.db ...
[+] Total: 19764 / Added 1556 entries
[+] Loading ./dbs/good-exports-part5.db ...
[+] Total: 404321 / Added 71962 entries
[+] Processing malware files ...
[+] Processing /home/htb-student/Samples/MalwareAnalysis/Test/shell.exe ...
[+] Generating statistical data ...
[+] Generating Super Rules ... (a lot of magic)
[+] Generating Simple Rules ...
[-] Applying intelligent filters to string findings ...
[-] Filtering string set for /home/htb-student/Samples/MalwareAnalysis/Test/shell.exe ...
[=] Generated 1 SIMPLE rules.
[=] All rules written to yargen_rules.yar
[+] yarGen run finished

```

On remarquera qu'un fichier nommé `yargen_rule.yar`est généré par `yarGen`et intègre des chaînes uniques, qui sont automatiquement extraites et insérées dans la règle.

```
dsgsec@htb[/htb]$ cat yargen_rules.yar
/*
   YARA Rule Set
   Author: yarGen Rule Generator
   Date: 2023-08-02
   Identifier: Test
   Reference: https://github.com/Neo23x0/yarGen
*/

/* Rule Set ----------------------------------------------------------------- */

rule _home_htb_student_Samples_MalwareAnalysis_Test_shell {
   meta:
      description = "Test - file shell.exe"
      author = "yarGen Rule Generator"
      reference = "https://github.com/Neo23x0/yarGen"
      date = "2023-08-02"
      hash1 = "bd841e796feed0088ae670284ab991f212cf709f2391310a85443b2ed1312bda"
   strings:
      $x1 = "C:\\Windows\\System32\\cmd.exe" fullword ascii
      $s2 = "http://ms-windows-update.com/svchost.exe" fullword ascii
      $s3 = "C:\\Windows\\System32\\notepad.exe" fullword ascii
      $s4 = "/k ping 127.0.0.1 -n 5" fullword ascii
      $s5 = "iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com" fullword ascii
      $s6 = "  VirtualQuery failed for %d bytes at address %p" fullword ascii
      $s7 = "[-] Error code is : %lu" fullword ascii
      $s8 = "C:\\Program Files\\VMware\\VMware Tools\\" fullword ascii
      $s9 = "Failed to open the registry key." fullword ascii
      $s10 = "  VirtualProtect failed with code 0x%x" fullword ascii
      $s11 = "Connection sent to C2" fullword ascii
      $s12 = "VPAPAPAPI" fullword ascii
      $s13 = "AWAVAUATVSH" fullword ascii
      $s14 = "45.33.32.156" fullword ascii
      $s15 = "  Unknown pseudo relocation protocol version %d." fullword ascii
      $s16 = "AQAPRQVH1" fullword ascii
      $s17 = "connect" fullword ascii /* Goodware String - occured 429 times */
      $s18 = "socket" fullword ascii /* Goodware String - occured 452 times */
      $s19 = "tSIcK<L" fullword ascii
      $s20 = "Windows-Update/7.6.7600.256 %s" fullword ascii
   condition:
      uint16(0) == 0x5a4d and filesize < 60KB and
      1 of ($x*) and 4 of them
}

```

Nous pouvons revoir la règle et la modifier si nécessaire, en ajoutant davantage de chaînes et de conditions pour améliorer sa fiabilité et son efficacité.

* * * * *

Détection des logiciels malveillants à l'aide des règles Yara
-------------------------------------------------------------

Nous pouvons ensuite utiliser cette règle pour analyser un répertoire comme suit.

```
dsgsec@htb[/htb]$ yara /home/htb-student/yarGen-0.23.4/yargen_rules.yar /home/htb-student/Samples/MalwareAnalysis/
home_htb_student_Samples_MalwareAnalysis_Test_shell /home/htb-student/Samples/MalwareAnalysis//shell.exe

```

Nous remarquerons que `shell.exe`c'est revenu !

Ci-dessous quelques références pour les règles YARA :

-   Documentation Yara : <https://yara.readthedocs.io/en/stable/writingrules.html>
-   Ressources Yara - <https://github.com/InQuest/awesome-yara>
-   Le rapport DFIR - <https://github.com/The-DFIR-Report/Yara-Rules>

Sigma
-----

`Sigma`est un format de règles complet et standardisé largement utilisé par les analystes et `Security Information and Event Management (SIEM)`les systèmes de sécurité. L'objectif est de détecter et d'identifier des modèles ou des comportements spécifiques qui pourraient potentiellement signifier des menaces ou des événements de sécurité. Le format standardisé des `Sigma`règles permet aux équipes de sécurité de définir et de diffuser une logique de détection sur diverses plateformes de sécurité.

Pour construire une `Sigma`règle basée sur certaines actions (par exemple, déposer un fichier dans un emplacement temporaire), nous pouvons concevoir un exemple de règle allant dans ce sens.

Code : sigma

```
title: Suspicious File Drop in Users Temp Location
status: experimental
description: Detects suspicious activity where a file is dropped in the temp location

logsource:
    category: process_creation
detection:
    selection:
        TargetFilename:
            - '*\\AppData\\Local\\Temp\\svchost.exe'
    condition: selection
    level: high

falsepositives:
    - Legitimate exe file drops in temp location

```

Dans ce cas, la règle est conçue pour identifier le moment où le fichier `svchost.exe`est déposé dans le `Temp`répertoire.

Pendant l'analyse, il est avantageux qu'un agent de surveillance du système fonctionne en permanence. Dans ce contexte, nous avons choisi `Sysmon`de rassembler les logs. `Sysmon`est un outil puissant qui capture des données détaillées sur les événements et facilite la création de `Sigma`règles. Ses catégories de journaux englobent la création de processus ( `EventID 1`), la connexion réseau ( `EventID 3`), la création de fichiers ( `EventID 11`), la modification du registre ( `EventID 13`), entre autres. L'examen minutieux de ces événements aide à identifier les indicateurs de compromission `IOC`et à comprendre les modèles de comportement, facilitant ainsi l'élaboration de règles de détection efficaces.

Par exemple, `Sysmon`a collecté des journaux tels que `process creation`, `process access`, `file creation`et `network connection`, entre autres, en réponse aux activités menées par `shell.exe`. Ces informations compilées s'avèrent essentielles pour améliorer notre compréhension du comportement de l'échantillon et développer des règles de détection plus précises et efficaces.

Processus de création de journaux :

![Image](https://academy.hackthebox.com/storage/modules/227/sysmon_01_process.png)

Journaux d'accès aux processus (non configurés dans les cibles Windows de ce module) :

![Image](https://academy.hackthebox.com/storage/modules/227/sysmon_10_access.png)

Journaux de création de fichiers :

![Image](https://academy.hackthebox.com/storage/modules/227/sysmon_11_file.png)

Journaux de connexion réseau :

![Image](https://academy.hackthebox.com/storage/modules/227/sysmon_03_network.png)

Ci-dessous quelques références pour les règles Sigma :

-   Documentation Sigma : <https://github.com/SigmaHQ/sigma/wiki/Specification>
-   Ressources Sigma - <https://github.com/SigmaHQ/sigma/tree/master/rules>
-   Le rapport DFIR - <https://github.com/The-DFIR-Report/Sigma-Rules/tree/main/rules>

